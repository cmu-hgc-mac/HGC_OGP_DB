# Package for OGP + Database: rwOGP
This package is intended to be used to read and write data from the OGP to a local database. The package is divided into two parts: 
1. CLI tool for automatic upload of data from the OGP to the local database. (`python rwOGP/main.py`)
2. GUI to read data from the local database to the OGP. (`python rwOGP/startGUI.py`)

For detailed explanations, refer to [How to use](#how-to-use) section.

## Getting started
Currently, there are two types of OGP templates to be used: one for baseplates/hexaboards [OGP_template_bp_hxb.txt](https://github.com/cmu-hgc-mac/HGC_OGP_DB/blob/cmu-merge/rwOGP/templates/OGP_template_bp_hxb.txt) and one for protomodules/modules [OGP_template_pm_module.txt](https://github.com/cmu-hgc-mac/HGC_OGP_DB/blob/cmu-merge/rwOGP/templates/OGP_template_pm_module.txt). Every `key: {$value}` pair in the template represents a variable in the OGP survey program. For example, for the pair `Operator: {$CernID}`, the OGP survey program needs to have a routine setting `CernID`. This can be done by either creating an user input variable called `CernID` or by setting the value of `CernID` in the OGP survey program to a fixed string. 

See the pictures below for examples of how to set variable routines in the OGP program. 
![OGP1](https://github.com/user-attachments/assets/d897793d-df3a-48fc-a04e-fd160cbf312f)
![OGP2](https://github.com/user-attachments/assets/eab83325-0726-4e05-b881-7defcc6751c2)
![OGP3](https://github.com/user-attachments/assets/d5837b11-1ceb-4c6b-adc1-87542269f7a0)

Next, survey a number of trays for the fiducials that will be referenced when calculating the offsets of protomodules and modules. Based on the surveyed results, create a `yaml` file formatted similar to [tray_example_LD_Full.yaml](https://github.com/cmu-hgc-mac/HGC_OGP_DB/blob/cmu-merge/rwOGP/templates/trays/tray_example_LD_Full.yaml). Note that not every single key in this tray file needs to be filled out. Depending on the different geometries of the boards assembled, only certain points need to be filled out. **Create an issue ticket if you have questions regarding which keys need to be filled out for specific configuration of geometries.**

Place these tray files in any directory of your choice, then run
```
python rwOGP/main.py --updatedir
```
choose to update `ogp_tray_dir`, and enter the directory path where the tray files are located. 

For further instructions or materials on how to survey a tray or the formatting of the results, refer to [this section](#general-understanding-of-offset-calculations).


### Method 1: Run Python directly
Clone the repository and install the required packages:
```
git clone git@github.com:cmu-hgc-mac/HGC_OGP_DB.git
```
Run the following command to postprocess and upload the OGP survey results to the database:
```
cd HGC_OGP_DB
python rwOGP/main.py
```
To inspect data from database
```
python rwOGP/startGUI.py
```

For more information on how to use the CLI tool, run:
```python rwOGP/main.py --help```
The following options are available: 
```python rwOGP/main.py --type baseplates```, for uploading a specific type of components.
```python rwOGP/main.py --print```, for viewing the current uploaded data.
```python rwOGP/main.py --clear```, for wipe upload record clean (used for re-uploading data)

### Method 2: Install as a package (Under Development)
In Python 3.6 or greater on the OGP computer: 
```
pip install git+https://github.com/cmu-hgc-mac/HGC_OGP_DB.git
```
Then run in terminal
```
uploadOGPresults
```
If run for the first time, this prompts user to enter a secure folder/directory to create a configuration file containing information about database connection and OGP survey results. Modify the configuration file to include the correct information.

Running this command after will automatically postprocess and upload the OGP survey results to the database.

## How to use:
The program finds the `.txt` files generated by metrology program in a specified output directory in `config.yaml` file (created when first run the program and modified using `python rwOGP/main.py --updatedir`). It then uploads the entry (including the automatically generated plots) to the correct table in database.

An example of the `output.txt` file is uploaded [here](rwOGP//templates/samples/320MLF3W2CM0121.txt).

This GUI contains two tabs: 'View Plots' and 'Upload Files'. Run `python rwOGP/startGUI.py` to start the GUI.
- View plots shows plots data from the OGP. (TBD: Change limit on number of files) 
- Upload Files lets the user upload .XLS output files containing OGP meaurements to the local db.
  - The **watch directory** _must contain_ the following subdirectories for the GUI to work:
    - baseplates
    - hexaboards
    - protomodules
    - modules
  - The OGP inspection files _must be configured to write to these locations_ by default type.
    - The .XLS files must be saved with the ID of the component and will be used as the part ID in the db.

![OGP_GUI](https://github.com/murthysindhu/HGC_DB_postgres/assets/58646122/dbeddf4c-2dc8-4da7-8f26-f916d1c69b74)

## Developer's Notes:
### General understanding of offset calculations
Refer to Calculations Guide.pptx by Paolo for definitions of FD points of different geometries and densities. 

To calculate both displacement and angular offsets, we need to determine an absolute center and another fiducial point, and this is done through surveying the assembly tray. The python program requires reading from a tray file that contains these tray survey results, for comparing the surveyed module center versus the assembly tray center. Some examples of tray surveys are provided in [here](rwOGP//templates/trays). 

Notice that the tray files provided in the directory have different pin positions to fill out. Some MACs (such as UCSB MAC) make more module geometries. These other shapes require pins to be in different locations around the assembly tray. For LDFull or HDFull only, creating a tray template file such as [tray_example_LD_Full.yaml](rwOGP//templates/trays/tray_example_LD_Full.yaml) may be necessary.

### Details on surveying LD Full assembly trays as an example
Take a look at [tray_example_LD_Full.yaml](rwOGP//templates/trays/tray_example_LD_Full.yaml), you'll have to fill out a tray file like this one for each position:

* Tray Number: This is the "Name" of the Assembly Tray. I suggest calling them something like "101" & "102" where the "10_" is the assembly tray and the "__1" is the position of the assembly tray.
*  Tray Name: Just call it "Tray _". (Fill in the blank with your tray number)
In the module_geoms section, you'll put "  ['LDF']  " because you're only making LD Full modules. 
* Tray Fiducial: This is the secondary tray fiducial location, for us this is the top left corner of our assembly tray. But more generally, it should be a vector from your origin fiducial to your secondary fiducial with respect to itself. That's why the x component is generally 0, and the y component is the distance between the two fiducials.  
* P1 Center, P1O, P2 Center, and P2M: These are the tray pin measurements. First establish your tray fiducial based coordinate system. Then measure the Center Pin, and Off Center Pin of your tray. Fill in P1 Center with your center pin measurement, and fill in P1O with your Off Center Pin measurement. Leave P2 points blank. 
* The Last Five: date_meas, time_meas, inspector, institution, and comment sections are all for keeping track of who did the tray measurements and when. Fill them out by matching the format they're in in the example. These can be uploaded to HGCAL Database as well, but only for once.

### Troubleshooting the program
#### Missing entries (data or header or the entire txt file)
1. Check if OGP survey program is properly named. Spaces are very likely to cause parsing issues and therefore should be avoided. 
Correct Example: `CMU_OGP_module_survey_2024`
2. Check if the routines are reporting results to Files. Turn Results for (X, Y, Z) on, and change the system setting to Link Results to Files. Do this for user input variables as well.
3. Check if the file output routine has filter applied. Uncheck the option.

#### Template change
- If the template is changed, how data is parsed from the OGP output files will also need to be modified accordingly in `src/param.py`.
- The meta data needs to follow the format: 
  ```
  LastModified: {ProjectLastModified}		
  Runtime: {RunDateTime}
  ```
  Otherwise [ttp](https://ttp.readthedocs.io/en/latest/) package will have trouble parsing the data.
  

## Using pgAdmin4 to view tables (Instructions to follow)
Install [postgreSQL-15 with pgAdmin4](https://www.pgadmin.org/download/) on your computers. Make sure you add ```psql``` to your path.


